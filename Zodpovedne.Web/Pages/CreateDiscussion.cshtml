@page "/discussion/create/{categoryCode}"
@model CreateDiscussionModel
@{
    ViewData["Title"] = "Nová diskuze";

    //Pokud je jakýkoliv text v ErrorMessage, tak se zobrazí a zbytek stránky se nevykreslí
    if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-warning">
            <h4>@Model.ErrorMessage</h4>
        </div>
        return;
    }
    //Pokud je jakýkoliv text v StatusMessage, tak se zobrazí úplně nahoře a pokračuje se ve vykreslování stránky
    if (!string.IsNullOrEmpty(Model.StatusMessage))
    {
        <div class="alert alert-info">
            <h4>@Model.StatusMessage</h4>
        </div>
    }
}

<!-- Hlavní container pro celou stránku -->
<div class="container">
    <!-- Záhlaví stránky s názvem kategorie -->
    <div class="row mb-3">
        <div class="col text-center">
            <h1>Nová diskuze</h1>
            <h5>Kategorie: @Model.CategoryName</h5>
        </div>
    </div>
    <div class="create-disscussion-wrapper shadow">
        <!-- Formulář pro vytvoření diskuze -->
        <div class="col-md-8 w-100">
            <form method="post">
                <!-- Validační zprávy pro celý formulář -->
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                <input type="hidden" asp-for="Input.CategoryId" />
                <!-- Přidáme skrytý input pro dočasný kód diskuze -->
                <input type="hidden" id="temp-discussion-code" value="@Model.TempDiscussionCode" />

                <!-- Pole pro nadpis diskuze -->
                <div class="mb-3">
                    <label asp-for="Input.Title" class="form-label">Nadpis</label>
                    <input asp-for="Input.Title" class="form-control" />
                    <span asp-validation-for="Input.Title" class="text-danger"></span>
                </div>

                <!-- Sekce s WYSIWYG editorem -->
                <div class="mb-3 ">
                    <label asp-for="Input.Content" class="form-label">Obsah</label>
                    <div id="toolbar-container"></div>
                    <div id="editor-container"></div>
                    <textarea asp-for="Input.Content" id="editor-content" style="display: none;"></textarea>
                    <span asp-validation-for="Input.Content" class="text-danger"></span>
                </div>

                <!-- Přidáme checkbox pro soukromou diskuzi -->
                <div class="mb-3 form-check">
                    <input type="checkbox" asp-for="IsPrivate" class="form-check-input" id="isPrivate" />
                    <label class="form-check-label" for="isPrivate">Diskuze jen pro kamarády</label>
                </div>

                <!-- Tlačítka pro ovládání formuláře -->
                <div class="mb-3 create-discusssion-btn-wrapper">
                    <div class="create-discussion-back-wrapper">
                        <a href="/Categories/@Model.CategoryCode" class="btn btn-secondary shadow">Zpět</a>
                        <button type="button" id="emoji-btn">&#128512;</button>
                    </div>
                    <button type="submit" class="btn btn-primary create-discussion-btn shadow" onclick="updateContent()">Vytvořit diskuzi</button>
                </div>
                <div id="emoji-list">
                    <!-- Emoji zůstávají stejné -->
                </div>
            </form>
        </div>
    </div>

</div>

<!-- Přidáme skrytý element pro nastavení, zda uživatel může nahrávat soubory -->
<div id="discussion-settings" data-can-upload="@Model.CanUploadFiles.ToString().ToLower()"></div>

@section Scripts {
    <!-- Načtení CKEditoru z CDN -->
    <script src="https://cdn.ckeditor.com/ckeditor5/40.0.0/decoupled-document/ckeditor.js"></script>
    <!-- Přidání validačních skriptů -->
    @await Html.PartialAsync("_ValidationScriptsPartial")
    <!-- Import adaptéru pro nahrávání souborů -->
    <script src="~/js/ckeditor-upload-adapter.js"></script>

    <script>
        // Pro přihlášeného uživatele uložíme jeho JWT do sessionStorage prohlížeče pro použití v upload adaptéru
        @if (Model.IsUserLoggedIn)
        {
            <text>
                    sessionStorage.setItem('JWTToken', '@Model.JwtToken');
            </text>
        }

        // Získání informace, zda uživatel může nahrávat soubory
        const canUploadFiles = document.getElementById("discussion-settings").dataset.canUpload === "true";

        // Globální proměnná pro přístup k editoru
        let editor;

        // Inicializace CKEditoru
        DecoupledEditor
            .create(document.querySelector('#editor-container'), {
                // Základní konfigurace nástrojů
                toolbar: [
                    'heading',
                    '|',
                    'bold',
                    'italic',
                    'link',
                    'bulletedList',
                    'numberedList',
                    '|',
                    ...(canUploadFiles ? ['imageUpload', '|'] : []), // Podmíněné přidání tlačítka pro nahrávání obrázků
                    'undo',
                    'redo'
                ],

                // Nastavení jazyka editoru
                language: 'cs',

                // Konfigurace pro obrázky - pouze pokud uživatel může nahrávat soubory
                ...(canUploadFiles ? {
                    image: {
                        toolbar: [
                            'imageTextAlternative',
                            '|',
                            'imageStyle:alignLeft',
                            'imageStyle:alignCenter',
                            'imageStyle:alignRight'
                        ],
                        // Definice stylů zarovnání
                        styles: {
                            options: [
                                'alignLeft',
                                'alignCenter',
                                'alignRight'
                            ]
                        },
                        // Nastavení upload URL
                        upload: {
                            types: ['jpeg', 'png', 'gif', 'jpg', 'webp']
                        }
                    },
                    // Přidání našeho vlastního adaptéru pro nahrávání
                    extraPlugins: [MyCustomUploadAdapterPlugin]
                } : {}),

                // Přidání vlastních CSS stylů do editoru
                contentStyles: [
                    '.ck-content img { max-width: 300px !important; max-height: 200px !important; object-fit: contain !important; margin: 5px !important; border: 1px solid #ddd !important; border-radius: 4px !important; padding: 3px !important; }'
                ]
            })
            .then(newEditor => {
                // Uložení instance editoru
                editor = newEditor;
                // Naplnění editoru obsahem z modelu (pokud existuje)
                if (document.querySelector('#editor-content').value) {
                    editor.setData(document.querySelector('#editor-content').value);
                }

                // Připojení toolbaru do příslušného containeru
                const toolbarContainer = document.querySelector('#toolbar-container');
                toolbarContainer.appendChild(editor.ui.view.toolbar.element);
            })
            .catch(error => {
                console.error('Chyba při inicializaci editoru:', error);
            });

        // Funkce pro přenos obsahu z editoru do skrytého textarea před odesláním formuláře
        function updateContent() {
            if (editor) {
                const content = editor.getData();
                const maxContentLength = 3000;

                if (content.length > maxContentLength) {
                    document.getElementById("modalMessage").textContent =
                    `Obsah diskuze nesmí být delší než ${maxContentLength} znaků. Aktuální délka: ${content.length}`;
                    new bootstrap.Modal(document.getElementById("errorModal")).show();

                    event.preventDefault(); // Zabrání odeslání formuláře
                    return false; // Zabránit odeslání formuláře
                }
                document.querySelector('#editor-content').value = editor.getData();
            }
        }

        // Kód pro emoji zůstává stejný
    </script>
    <script src="~/js/new-discussion.js"></script>
}