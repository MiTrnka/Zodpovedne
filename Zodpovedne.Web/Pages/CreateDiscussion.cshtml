@page "/discussion/create/{categoryCode}"
@model CreateDiscussionModel
@{
    ViewData["Title"] = "Nová diskuze";

    //Pokud je jakýkoliv text v ErrorMessage, tak se zobrazí a zbytek stránky se nevykreslí
    if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-warning">
            <h4>@Model.ErrorMessage</h4>
        </div>
        return;
    }
    //Pokud je jakýkoliv text v StatusMessage, tak se zobrazí úplně nahoře a pokračuje se ve vykreslování stránky
    if (!string.IsNullOrEmpty(Model.StatusMessage))
    {
        <div class="alert alert-info">
            <h4>@Model.StatusMessage</h4>
        </div>
    }
}

<!-- Hlavní container pro celou stránku -->
<div class="container">
    <!-- Záhlaví stránky s názvem kategorie -->
    <div class="row mb-3">
        <div class="col text-center">
            <h1>Nová diskuze</h1>
            <h5>Kategorie: @Model.CategoryName</h5>
        </div>
    </div>
    <div class="create-disscussion-wrapper shadow">
        <!-- Formulář pro vytvoření diskuze -->
        <div class="col-md-8 w-100">
            <form method="post" id="create-discussion-form">
                <!-- Validační zprávy pro celý formulář -->
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                <input type="hidden" asp-for="Input.CategoryId" />
                <!-- Přidáme skrytý input pro dočasný kód diskuze -->
                <input type="hidden" id="temp-discussion-code" value="@Model.TempDiscussionCode" />

                <!-- Pole pro nadpis diskuze -->
                <div class="mb-3">
                    <label asp-for="Input.Title" class="form-label">Nadpis</label>
                    <input asp-for="Input.Title" class="form-control" />
                    <span asp-validation-for="Input.Title" class="text-danger"></span>
                </div>

                <!-- Sekce s WYSIWYG editorem -->
                <div class="mb-3 ">
                    <label asp-for="Input.Content" class="form-label">Obsah</label>
                    <div id="toolbar-container"></div>
                    <div id="editor-container"></div>
                    <textarea asp-for="Input.Content" id="editor-content" style="display: none;"></textarea>
                    <span asp-validation-for="Input.Content" class="text-danger"></span>
                </div>

                <!-- Přidáme checkbox pro soukromou diskuzi -->
                <div class="mb-3 form-check">
                    <input type="checkbox" asp-for="IsPrivate" class="form-check-input" id="isPrivate" />
                    <label class="form-check-label" for="isPrivate">Diskuze jen pro kamarády</label>
                </div>

                <!-- Tlačítka pro ovládání formuláře -->
                <div class="mb-3 create-discusssion-btn-wrapper">
                    <div class="create-discussion-back-wrapper">
                        <a href="/Categories/@Model.CategoryCode" class="btn btn-secondary shadow" id="back-button">Zpět</a>
                        <button type="button" id="emoji-btn">&#128512;</button>
                    </div>
                    <button type="submit" class="btn btn-primary create-discussion-btn shadow" id="submit-button">Vytvořit diskuzi</button>
                </div>
                <div id="emoji-list">
                    <!-- Emoji zůstávají stejné -->
                </div>
            </form>
        </div>
    </div>

</div>

<!-- Přidáme skrytý element pro nastavení, zda uživatel může nahrávat soubory -->
<div id="discussion-settings" data-can-upload="@Model.CanUploadFiles.ToString().ToLower()" data-base-url="@Model.BaseUrl"></div>

@section Scripts {
    <!-- Načtení CKEditoru z CDN -->
    <script src="https://cdn.ckeditor.com/ckeditor5/40.0.0/decoupled-document/ckeditor.js"></script>
    <!-- Přidání validačních skriptů -->
    @await Html.PartialAsync("_ValidationScriptsPartial")
    <!-- Import adaptéru pro nahrávání souborů -->
    <script src="~/js/ckeditor-upload-adapter.js"></script>

    <script>
        // Pro přihlášeného uživatele uložíme jeho JWT do sessionStorage prohlížeče pro použití v upload adaptéru
        @if (Model.IsUserLoggedIn)
        {
            <text>
                    sessionStorage.setItem('JWTToken', '@Model.JwtToken');
            </text>
        }

        // Získání informace, zda uživatel může nahrávat soubory
        const canUploadFiles = document.getElementById("discussion-settings").dataset.canUpload === "true";
        const baseUrl = document.getElementById("discussion-settings").dataset.baseUrl;

        // Globální proměnná pro přístup k editoru
        let editor;
        // Proměnná pro sledování nahraných obrázků
        let uploadedImages = [];

        // Inicializace CKEditoru
        DecoupledEditor
            .create(document.querySelector('#editor-container'), {
                // Základní konfigurace nástrojů
                toolbar: [
                    'heading',
                    '|',
                    'bold',
                    'italic',
                    'link',
                    'bulletedList',
                    'numberedList',
                    '|',
                    ...(canUploadFiles ? ['imageUpload', '|'] : []), // Podmíněné přidání tlačítka pro nahrávání obrázků
                    'undo',
                    'redo'
                ],

                // Nastavení jazyka editoru
                language: 'cs',

                // Konfigurace pro obrázky - pouze pokud uživatel může nahrávat soubory
                ...(canUploadFiles ? {
                    image: {
                        toolbar: [
                            'imageTextAlternative',
                            '|',
                            'imageStyle:alignLeft',
                            'imageStyle:alignCenter',
                            'imageStyle:alignRight'
                        ],
                        // Definice stylů zarovnání
                        styles: {
                            options: [
                                'alignLeft',
                                'alignCenter',
                                'alignRight'
                            ]
                        },
                        // Nastavení upload URL
                        upload: {
                            types: ['jpeg', 'png', 'gif', 'jpg', 'webp']
                        }
                    },
                    // Přidání našeho vlastního adaptéru pro nahrávání
                    extraPlugins: [MyCustomUploadAdapterPlugin]
                } : {}),

                // Přidání vlastních CSS stylů do editoru
                contentStyles: [
                    '.ck-content img { max-width: 300px !important; max-height: 200px !important; object-fit: contain !important; margin: 5px !important; border: 1px solid #ddd !important; border-radius: 4px !important; padding: 3px !important; }'
                ]
            })
            .then(newEditor => {
                // Uložení instance editoru
                editor = newEditor;
                // Naplnění editoru obsahem z modelu (pokud existuje)
                if (document.querySelector('#editor-content').value) {
                    editor.setData(document.querySelector('#editor-content').value);
                }

                // Připojení toolbaru do příslušného containeru
                const toolbarContainer = document.querySelector('#toolbar-container');
                toolbarContainer.appendChild(editor.ui.view.toolbar.element);

                // Sledování nahraných obrázků
                if (canUploadFiles) {
                    // Poslouchání události 'change:data', která se spustí při změně obsahu
                    editor.model.document.on('change:data', () => {
                        trackUploadedImages();
                    });
                }
            })
            .catch(error => {
                console.error('Chyba při inicializaci editoru:', error);
            });

        // Funkce pro sledování nahraných obrázků
        function trackUploadedImages() {
            if (!editor) return;

            const content = editor.getData();
            const tempCode = document.getElementById('temp-discussion-code').value;
            const uploadFolder = `/uploads/discussions/${tempCode}/`;

            // Najdeme všechny obrázky v obsahu
            const imgRegex = /<img[^>]+src="([^"]+)"[^>]*>/g;
            const currentImages = new Set();

            let match;
            // Extrahujeme URL všech obrázků z obsahu
            while ((match = imgRegex.exec(content)) !== null) {
                const imageUrl = match[1];
                // Zpracujeme pouze obrázky patřící k této diskuzi
                if (imageUrl.includes(uploadFolder)) {
                    const fileName = imageUrl.split('/').pop();
                    if (fileName) {
                        currentImages.add(fileName);
                    }
                }
            }

            // Aktualizujeme seznam nahraných obrázků
            uploadedImages = Array.from(currentImages);
        }

        // Funkce pro čištění nepoužitých obrázků
        async function cleanupUnusedImages() {
            if (!canUploadFiles) return;

            const tempCode = document.getElementById('temp-discussion-code').value;

            try {
                // Získání seznamu všech nahraných obrázků pro tuto diskuzi
                const response = await fetch(`/upload/list?discussionCode=${tempCode}`, {
                    headers: {
                        'Authorization': `Bearer ${sessionStorage.getItem('JWTToken')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.files && data.files.length > 0) {
                        // Pro každý soubor zkontrolujeme, zda je v seznamu aktuálně používaných
                        for (const file of data.files) {
                            if (!uploadedImages.includes(file.name)) {
                                // Pokud soubor není používán, smažeme ho
                                await fetch(`/upload/delete-file`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${sessionStorage.getItem('JWTToken')}`
                                    },
                                    body: JSON.stringify({
                                        discussionCode: tempCode,
                                        fileName: file.name
                                    })
                                });
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Chyba při čištění nepoužitých obrázků:', error);
            }
        }

        // Funkce pro smazání adresáře s obrázky
        async function deleteImagesDirectory() {
            if (!canUploadFiles) return;

            const tempCode = document.getElementById('temp-discussion-code').value;

            try {
                await fetch(`${baseUrl}upload/delete-directory`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionStorage.getItem('JWTToken')}`
                    },
                    body: JSON.stringify({
                        code: tempCode
                    })
                });
            } catch (error) {
                console.error('Chyba při mazání adresáře s obrázky:', error);
            }
        }

        // Funkce pro přenos obsahu z editoru do skrytého textarea před odesláním formuláře
        function updateContent() {
            if (editor) {
                const content = editor.getData();
                const maxContentLength = 3000;

                if (content.length > maxContentLength) {
                    document.getElementById("modalMessage").textContent =
                    `Obsah diskuze nesmí být delší než ${maxContentLength} znaků. Aktuální délka: ${content.length}`;
                    new bootstrap.Modal(document.getElementById("errorModal")).show();

                    event.preventDefault(); // Zabrání odeslání formuláře
                    return false; // Zabránit odeslání formuláře
                }

                // Aktualizace seznamu nahraných obrázků
                trackUploadedImages();
                // Vyčištění nepoužitých obrázků před odesláním formuláře
                cleanupUnusedImages();

                document.querySelector('#editor-content').value = editor.getData();
            }
        }

        // Přidání event listenerů pro tlačítka
        document.addEventListener('DOMContentLoaded', function() {
            // Získání formuláře a tlačítek
            const form = document.getElementById('create-discussion-form');
            const backButton = document.getElementById('back-button');
            const submitButton = document.getElementById('submit-button');

            // Poslouchání události odeslání formuláře
            form.addEventListener('submit', function(event) {
                updateContent();
                // Čištění se provede v updateContent
            });

            // Poslouchání kliknutí na tlačítko Zpět
            backButton.addEventListener('click', function(event) {
                // Při kliknutí na Zpět smažeme celý adresář s obrázky
                if (canUploadFiles) {
                    event.preventDefault();

                    // Potvrzení opuštění stránky
                    if (confirm('Opravdu chcete opustit stránku? Všechny vaše změny budou ztraceny.')) {
                        deleteImagesDirectory().then(() => {
                            // Po smazání přesměrujeme na stránku kategorie
                            window.location.href = `/Categories/${document.querySelector('[asp-for="CategoryCode"]').value}`;
                        });
                    }
                }
            });
        });

        // Kód pro emoji zůstává stejný
    </script>
    <script src="~/js/new-discussion.js"></script>
}