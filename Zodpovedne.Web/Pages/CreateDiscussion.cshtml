@page "/discussion/create/{categoryCode}"
@model CreateDiscussionModel
@{
    ViewData["Title"] = "Nová diskuze";

    //Pokud je jakýkoliv text v ErrorMessage, tak se zobrazí a zbytek stránky se nevykreslí
    if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-warning">
            <h4>@Model.ErrorMessage</h4>
        </div>
        return;
    }
    //Pokud je jakýkoliv text v StatusMessage, tak se zobrazí úplně nahoře a pokračuje se ve vykreslování stránky
    if (!string.IsNullOrEmpty(Model.StatusMessage))
    {
        <div class="alert alert-info">
            <h4>@Model.StatusMessage</h4>
        </div>
    }
}

<!-- Hlavní container pro celou stránku -->
<div class="container">
    <!-- Záhlaví stránky s názvem kategorie -->
    <div class="row mb-3">
        <div class="col text-center">
            <h1>Nová diskuze</h1>
            <h5>Kategorie: @Model.CategoryName</h5>
        </div>
    </div>
    <div class="create-disscussion-wrapper shadow mt-2">
        <!-- Formulář pro vytvoření diskuze -->
        <div class="col-md-8 w-100">
            <form method="post" id="create-discussion-form">
                <!-- Validační zprávy pro celý formulář -->
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                <input type="hidden" asp-for="Input.CategoryId" />
                <!-- Přidáme skrytý input pro dočasný kód diskuze -->
                <input type="hidden" id="temp-discussion-code" value="@Model.TempDiscussionCode" />

                <!-- Pole pro nadpis diskuze -->
                <div class="mb-3">
                    <label asp-for="Input.Title" class="form-label">Nadpis</label>
                    <input asp-for="Input.Title" class="form-control" />
                    <span asp-validation-for="Input.Title" class="text-danger"></span>
                </div>

                <!-- Sekce s WYSIWYG editorem -->
                <div class="mb-3 ">
                    <label asp-for="Input.Content" class="form-label">Obsah</label>
                    <div id="toolbar-container"></div>
                    <div id="editor-container"></div>
                    <textarea asp-for="Input.Content" id="editor-content" style="display: none;"></textarea>
                    <span asp-validation-for="Input.Content" class="text-danger"></span>
                </div>

                <!-- Přidání sekce pro volby diskuze -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <!-- Přidáme checkbox pro soukromou diskuzi -->
                        <div class="form-check mb-2">
                            <input type="checkbox" asp-for="IsPrivate" class="form-check-input" id="isPrivate" />
                            <label class="form-check-label" for="isPrivate">Diskuze jen pro přátele</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <!-- Přidáme checkbox pro vytvoření hlasování -->
                        <div class="form-check mb-2">
                            <input type="checkbox" asp-for="HasVoting" class="form-check-input" id="hasVoting" />
                            <label class="form-check-label" for="hasVoting">Vytvořit hlasování</label>
                        </div>
                    </div>
                </div>

                <!-- Sekce pro hlasování - skrytá, dokud uživatel neaktivuje vytvoření hlasování -->
                <div id="voting-section" class="mb-3 p-3 border rounded bg-light" style="display: none;">
                    <h5 class="mb-3">Hlasování</h5>

                    <!-- Přepínač typu hlasování -->
                    <div class="mb-3">
                        <label class="form-label">Stav hlasování</label>
                        <select asp-for="Input.VoteType" class="form-select" id="voting-type">
                            <option value="1" selected>Viditelné a aktivní</option>
                            <option value="3">Skryté (viditelné pouze pro autora)</option>
                        </select>
                        <div class="form-text">Určuje, zda a jak bude hlasování zobrazeno uživatelům.</div>
                    </div>

                    <!-- Tlačítko pro přidání nové otázky -->
                    <div class="mb-3">
                        <button type="button" class="btn btn-sm btn-success" id="add-question-btn">
                            <i class="bi bi-plus-circle"></i> Přidat novou otázku
                        </button>
                    </div>

                    <!-- Seznam otázek hlasování -->
                    <div id="voting-questions-container">
                        <!-- Zde budou dynamicky přidávány otázky -->
                        <div class="text-muted text-center py-3" id="no-questions-message">
                            Zatím nejsou přidány žádné otázky.
                        </div>
                    </div>

                    <!-- Šablona pro novou otázku (skrytá) -->
                    <template id="question-template">
                        <div class="voting-question card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span class="question-number">Otázka #</span>
                                <div>
                                    <button type="button" class="btn btn-sm btn-outline-danger remove-question-btn">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Text otázky</label>
                                    <textarea class="form-control question-text" rows="2" maxlength="400" required></textarea>
                                    <div class="form-text text-end">
                                        <span class="char-count">0</span>/400 znaků
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">Pořadí zobrazení</label>
                                    <input type="number" class="form-control question-order" min="1" value="1" required>
                                </div>
                                <!-- Skrytý input pro ID otázky (při editaci) -->
                                <input type="hidden" class="question-id" value="">
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Tlačítka pro ovládání formuláře -->
                <div class="mb-3 create-discusssion-btn-wrapper">
                    <div class="create-discussion-back-wrapper">
                        <a href="/Categories/@Model.CategoryCode" class="btn btn-secondary shadow" id="back-button">Zpět</a>
                        <button type="button" id="emoji-btn">&#128512;</button>
                    </div>
                    <button type="submit" class="btn btn-primary create-discussion-btn shadow" id="submit-button">Vytvořit diskuzi</button>
                </div>
                <div id="emoji-list">
                    <!-- Srdce a like emoji -->
                    <span class="emoji">&#x2764;&#xFE0F;</span>     <!-- červené srdce -->
                    <span class="emoji">&#128077;</span>    <!-- palec nahoru -->
                    <span class="emoji">&#128079;</span>    <!-- tleskání -->
                    <span class="emoji">&#128076;</span>    <!-- OK symbol -->
                    <span class="emoji">&#128591;</span>    <!-- sepjaté ruce -->
                    <span class="emoji">&#128075;</span>    <!-- mávající ruka -->
                    <span class="emoji">&#128170;</span>    <!-- biceps -->
                    <span class="emoji">&#128400;</span>    <!-- OK symbol ruka -->
                    <!-- Standardní smajlíky vyjadřující emoce -->
                    <span class="emoji">&#128512;</span>    <!-- široký úsměv -->
                    <span class="emoji">&#128513;</span>    <!-- úsměv s velkýma očima -->
                    <span class="emoji">&#128514;</span>    <!-- smích se slzami -->
                    <span class="emoji">&#128515;</span>    <!-- úsměv s úsměvnýma očima -->
                    <span class="emoji">&#128516;</span>    <!-- úsměv s přimhouřenýma očima -->
                    <span class="emoji">&#128517;</span>    <!-- úsměv s potem -->
                    <span class="emoji">&#128518;</span>    <!-- úsměv s šilhavýma očima -->
                    <span class="emoji">&#128519;</span>    <!-- anděl -->
                    <span class="emoji">&#128520;</span>    <!-- ďáblík -->
                    <span class="emoji">&#128521;</span>    <!-- mrkající -->
                    <span class="emoji">&#128522;</span>    <!-- spokojený -->
                    <span class="emoji">&#128523;</span>    <!-- olizující se -->
                    <span class="emoji">&#128524;</span>    <!-- bez výrazu -->
                    <span class="emoji">&#128525;</span>    <!-- zamilovaný -->
                    <span class="emoji">&#128526;</span>    <!-- chladný s brýlemi -->
                    <span class="emoji">&#128527;</span>    <!-- samolibý -->
                    <span class="emoji">&#128528;</span>    <!-- neutrální -->
                    <span class="emoji">&#128529;</span>    <!-- bezvýrazný -->
                    <span class="emoji">&#128530;</span>    <!-- zklamaný -->
                    <span class="emoji">&#128531;</span>    <!-- studený pot -->
                    <span class="emoji">&#128532;</span>    <!-- smutný -->
                    <span class="emoji">&#128533;</span>    <!-- zmatený -->
                    <span class="emoji">&#128534;</span>    <!-- sklíčený -->
                    <span class="emoji">&#128535;</span>    <!-- polibek -->
                    <span class="emoji">&#128536;</span>    <!-- polibek s očima -->
                    <span class="emoji">&#128537;</span>    <!-- milující -->
                    <span class="emoji">&#128538;</span>    <!-- polibek s úsměvem -->
                    <span class="emoji">&#128539;</span>    <!-- vypláznutý jazyk -->
                    <span class="emoji">&#128540;</span>    <!-- vypláznutý jazyk a mrkání -->
                    <span class="emoji">&#128541;</span>    <!-- vypláznutý jazyk a šilhání -->
                    <span class="emoji">&#128542;</span>    <!-- zklamaný -->
                    <span class="emoji">&#128543;</span>    <!-- uražený -->
                    <span class="emoji">&#128544;</span>    <!-- vzteklý -->
                    <span class="emoji">&#128545;</span>    <!-- rozzlobený -->
                    <span class="emoji">&#128546;</span>    <!-- plačící -->
                    <span class="emoji">&#128547;</span>    <!-- trpící -->
                    <span class="emoji">&#128548;</span>    <!-- zamračený se zuby -->
                    <span class="emoji">&#128549;</span>    <!-- úzkostný s potem -->
                    <span class="emoji">&#128550;</span>    <!-- překvapený -->
                    <span class="emoji">&#128551;</span>    <!-- zklamaný ale ulevený -->
                    <span class="emoji">&#128552;</span>    <!-- vyděšený -->
                    <span class="emoji">&#128553;</span>    <!-- unavený -->
                    <span class="emoji">&#128554;</span>    <!-- ospalý -->
                    <span class="emoji">&#128555;</span>    <!-- unavený -->
                    <span class="emoji">&#128556;</span>    <!-- grimasa -->
                    <span class="emoji">&#128557;</span>    <!-- hlasitě plačící -->
                    <span class="emoji">&#128558;</span>    <!-- překvapený s otevřenými ústy -->
                    <span class="emoji">&#128559;</span>    <!-- překvapený -->
                    <span class="emoji">&#128560;</span>    <!-- vyděšený -->
                    <span class="emoji">&#128561;</span>    <!-- křičící -->
                    <span class="emoji">&#129326;</span>    <!-- nevolnost -->
                    <span class="emoji">&#129327;</span>    <!-- kýchnutí -->
                    <span class="emoji">&#129318;</span>    <!-- obracející oči -->
                    <span class="emoji">&#129335;</span>    <!-- pokrčení rameny -->
                    <span class="emoji">&#x1F648;</span>    <!-- opice -->
                    <span class="emoji">&#128580;</span>    <!-- nedůvěřivý -->
                    <span class="emoji">&#129296;</span>    <!-- mrzoutský -->
                    <span class="emoji">&#129301;</span>    <!-- po úrazu -->
                    <span class="emoji">&#x1F321;</span>    <!-- teploměr -->
                    <span class="emoji">&#129314;</span>    <!-- na zvracení -->
                    <span class="emoji">&#128564;</span>    <!-- spící -->
                    <span class="emoji">&#128567;</span>    <!-- s rouškou -->
                    <span class="emoji">&#128562;</span>    <!-- šokovaný -->
                    <!-- Oslavné a sváteční emoji -->
                    <span class="emoji">&#127881;</span>    <!-- party popper -->
                    <span class="emoji">&#x2728;</span>    <!-- hvězdicky -->
                    <span class="emoji">&#128144;</span>    <!-- kvetina -->
                    <span class="emoji">&#127942;</span>    <!-- trofej -->
                    <span class="emoji">&#127874;</span>    <!-- narozeninový dort -->
                    <span class="emoji">&#x1F381;</span>    <!-- dárek -->
                    <span class="emoji">&#127872;</span>    <!-- dárek -->
                    <span class="emoji">&#127882;</span>    <!-- konfety -->
                    <span class="emoji">&#127880;</span>    <!-- hvězda -->
                    <!-- Jídlo a pití -->
                    <span class="emoji">&#127849;</span>    <!-- donut -->
                    <span class="emoji">&#127846;</span>    <!-- zmrzlina -->
                    <span class="emoji">&#127863;</span>    <!-- víno -->
                    <span class="emoji">&#127866;</span>    <!-- pivo -->
                    <span class="emoji">&#129365;</span>    <!-- brambora -->
                    <span class="emoji">&#129379;</span>    <!-- muffin -->
                    <span class="emoji">&#127814;</span>    <!-- hruška -->
                    <span class="emoji">&#129382;</span>    <!-- želé -->
                    <span class="emoji">&#127812;</span>    <!-- houby -->
                    <span class="emoji">&#127836;</span>    <!-- nudle -->
                    <span class="emoji">&#127828;</span>    <!-- hamburger -->
                    <span class="emoji">&#127839;</span>    <!-- hranolky -->
                    <span class="emoji">&#127852;</span>    <!-- čokoláda -->
                    <span class="emoji">&#127829;</span>    <!-- pizza -->
                    <span class="emoji">&#129366;</span>    <!-- chleba -->
                    <span class="emoji">&#129472;</span>    <!-- čaj -->
                    <span class="emoji">&#127851;</span>    <!-- lízátko -->
                    <span class="emoji">&#129375;</span>    <!-- vajíčko -->
                    <span class="emoji">&#129360;</span>    <!-- palačinka -->
                    <span class="emoji">&#129367;</span>    <!-- čajová konvice -->
                    <span class="emoji">&#127855;</span>    <!-- koktejl -->
                    <!-- Zvířata -->
                    <span class="emoji">&#128054;</span>    <!-- pes -->
                    <span class="emoji">&#128049;</span>    <!-- kočka -->
                    <span class="emoji">&#128008;</span>    <!-- kočka -->
                    <span class="emoji">&#128021;</span>    <!-- prasátko -->
                    <span class="emoji">&#128039;</span>    <!-- kuře -->
                    <span class="emoji">&#128038;</span>    <!-- pták -->
                    <span class="emoji">&#128044;</span>    <!-- kuře -->
                    <span class="emoji">&#128023;</span>    <!-- ovce -->
                    <span class="emoji">&#128040;</span>    <!-- koala -->
                    <span class="emoji">&#129409;</span>    <!-- lama -->
                    <span class="emoji">&#129418;</span>    <!-- liška -->
                    <!-- Květiny a příroda -->
                    <span class="emoji">&#127808;</span>    <!-- čtyřlístek -->
                    <span class="emoji">&#x1F335;</span>    <!-- kaktus -->
                    <span class="emoji">&#x1F334;</span>    <!-- palma -->
                    <span class="emoji">&#127794;</span>    <!-- jehličnatý strom -->
                    <span class="emoji">&#127793;</span>    <!-- listnatý strom -->
                    <span class="emoji">&#127807;</span>    <!-- tulipán -->
                    <span class="emoji">&#127799;</span>    <!-- růže -->
                    <span class="emoji">&#127804;</span>    <!-- slunečnice -->
                    <span class="emoji">&#127802;</span>    <!-- zvadlá květina -->
                    <span class="emoji">&#127809;</span>    <!-- javor -->
                    <span class="emoji">&#127810;</span>    <!-- listí -->
                    <!-- Počasí a vesmír -->
                    <span class="emoji">&#9728;</span>      <!-- slunce -->
                    <span class="emoji">&#11088;</span>     <!-- hvězda -->
                    <span class="emoji">&#127771;</span>    <!-- měsíc -->
                    <span class="emoji">&#9889;</span>      <!-- blesk -->
                    <span class="emoji">&#9729;</span>      <!-- mrak -->
                    <span class="emoji">&#127785;</span>    <!-- tornádo -->
                    <span class="emoji">&#127782;</span>    <!-- duha -->
                    <span class="emoji">&#10052;</span>     <!-- sněhová vločka -->
                    <span class="emoji">&#x2603;</span>     <!-- sněhulák -->
                    <span class="emoji">&#9748;</span>      <!-- deštník -->
                    <!-- Doprava a budovy -->
                    <span class="emoji">&#128663;</span>    <!-- auto -->
                    <span class="emoji">&#9992;</span>      <!-- letadlo -->
                    <span class="emoji">&#x1F3D6;</span>      <!-- letadlo -->
                    <span class="emoji">&#128674;</span>    <!-- loď -->
                    <span class="emoji">&#128690;</span>    <!-- kolo -->
                    <span class="emoji">&#128657;</span>    <!-- ambulance -->
                    <span class="emoji">&#x1F514;</span>    <!-- zvonek -->
                    <span class="emoji">&#9888;</span>      <!-- varování -->
                    <span class="emoji">&#128680;</span>    <!-- policie -->
                    <span class="emoji">&#128643;</span>    <!-- metro -->
                    <span class="emoji">&#128642;</span>    <!-- lokomotiva -->
                    <span class="emoji">&#127974;</span>    <!-- budova -->
                    <span class="emoji">&#127968;</span>    <!-- dům -->
                    <span class="emoji">&#127981;</span>    <!-- továrna -->
                    <span class="emoji">&#127970;</span>    <!-- vysoká budova -->
                    <!-- Různé -->
                    <span class="emoji">&#128176;</span>    <!-- peníze s křídly -->
                    <span class="emoji">&#128181;</span>    <!-- měna -->
                    <span class="emoji">&#x1F4D6;</span>    <!-- kniha -->
                    <span class="emoji">&#x1F4DA;</span>    <!-- knihy -->
                    <span class="emoji">&#128197;</span>    <!-- kalendář -->
                    <span class="emoji">&#9989;</span>      <!-- zelená značka zaškrtnutí -->
                    <span class="emoji">&#10060;</span>     <!-- červený křížek -->
                    <span class="emoji">&#128066;</span>    <!-- ucho -->
                    <span class="emoji">&#128064;</span>    <!-- oči -->
                    <span class="emoji">&#128067;</span>    <!-- nos -->
                    <span class="emoji">&#127936;</span>    <!-- basketbal -->
                    <span class="emoji">&#127938;</span>    <!-- lyžař -->
                    <span class="emoji">&#9917;</span>      <!-- fotbalový míč -->
                    <span class="emoji">&#x1F945;</span>    <!-- brána -->
                    <span class="emoji">&#127939;</span>    <!-- běžec -->
                    <span class="emoji">&#128240;</span>    <!-- noviny -->
                    <span class="emoji">&#128241;</span>    <!-- telefon -->
                    <span class="emoji">&#x1F4FA;</span>    <!-- tv -->
                    <span class="emoji">&#128269;</span>    <!-- lupa -->
                    <span class="emoji">&#128373;</span>    <!-- detektiv -->
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Přidáme skrytý element pro nastavení, zda uživatel může nahrávat soubory -->
<div id="discussion-settings" data-can-upload="@Model.CanUploadFiles.ToString().ToLower()" data-base-url="@Model.BaseUrl"></div>

@section Scripts {
    <!-- Načtení CKEditoru z CDN -->
    <script src="https://cdn.ckeditor.com/ckeditor5/40.0.0/classic/ckeditor.js"></script>
    <!-- Přidání validačních skriptů -->
    @await Html.PartialAsync("_ValidationScriptsPartial")
    <!-- Import adaptéru pro nahrávání souborů -->
    <script src="~/js/ckeditor-upload-adapter.js"></script>
    <!-- Import skriptu pro hlasování -->
    <script src="~/js/voting.js" asp-append-version="true"></script>

    <script>
        // Pro přihlášeného uživatele uložíme jeho JWT do sessionStorage prohlížeče pro použití v upload adaptéru
        @if (Model.IsUserLoggedIn)
        {
            <text>
                    sessionStorage.setItem('JWTToken', '@Model.JwtToken');
            </text>
        }

        // Získání informace, zda uživatel může nahrávat soubory
        const canUploadFiles = document.getElementById("discussion-settings").dataset.canUpload === "true";
        const baseUrl = document.getElementById("discussion-settings").dataset.baseUrl;

        // Globální proměnná pro přístup k editoru
        let editor;
        // Proměnná pro sledování nahraných obrázků
        let uploadedImages = [];

        // Inicializace CKEditoru
        ClassicEditor
            .create(document.querySelector('#editor-container'), {
                // Základní konfigurace nástrojové lišty
                toolbar: [
                    'heading',
                    '|',
                    'bold',
                    'italic',
                    'link',
                    'bulletedList',
                    'numberedList',
                    '|',
                    'alignment',
                    '|',
                    ...(canUploadFiles ? ['imageUpload', '|'] : []), // Podmíněné přidání tlačítka pro nahrávání obrázků
                    'undo',
                    'redo'
                ],
                language: 'cs',
                alignment: {
                    options: ['left', 'center', 'right', 'justify']
                },
                // Konfigurace obrázků - pouze pokud uživatel může nahrávat soubory
                ...(canUploadFiles ? {
                    image: {
                        insert: {
                            type: 'inline' // Změna výchozího stylu na inline
                        },
                        toolbar: [
                            'imageTextAlternative',
                            '|',
                            'imageStyle:inline',        // Plovoucí obrázek
                            'imageStyle:alignLeft',    // Zarovnání vlevo
                            'imageStyle:alignCenter',  // Zarovnání na střed
                            'imageStyle:alignRight'   // Zarovnání vpravo
                        ],
                        resizeOptions: [
                            {
                                name: 'original',
                                value: null,
                                label: 'Originální velikost'
                            },
                            {
                                name: 'responsive',
                                value: null,
                                label: 'Responzivní'
                            }
                        ],
                        // Definice stylů zarovnání - použití standardních CKEditor stylů
                        styles: {
                            options: [
                                { name: 'inline', title: 'Plovoucí obrázek', icon: 'inline' },
                                { name: 'alignLeft', title: 'Zarovnat vlevo', icon: 'left' },
                                { name: 'alignCenter', title: 'Zarovnat na střed', icon: 'center' },
                                { name: 'alignRight', title: 'Zarovnat vpravo', icon: 'right' }
                            ]
                        },
                        // Nastavení upload URL
                        upload: {
                            types: ['jpeg', 'png', 'gif', 'jpg', 'webp']
                        }
                    },
                    // Přidání našeho vlastního adaptéru pro nahrávání
                    extraPlugins: [MyCustomUploadAdapterPlugin]
                } : {})
            })
            .then(editor => {
                // Uložení instance editoru
                window.editor = editor;
                // Naplnění editoru obsahem z modelu (pokud existuje)
                if (document.querySelector('#editor-content').value) {
                    editor.setData(document.querySelector('#editor-content').value);
                }
                    // Sledování nahraných obrázků
                    if (canUploadFiles) {
                        // Poslouchání události 'change:data', která se spustí při změně obsahu
                        editor.model.document.on('change:data', () => {
                            trackUploadedImages();
                        });
                    }
            })
            .catch(error => {
                console.error('Chyba při inicializaci editoru:', error);
            });

        // Funkce pro sledování nahraných obrázků
        function trackUploadedImages() {
            if (!window.editor) return;

            const content = window.editor.getData();
            const tempCode = document.getElementById('temp-discussion-code').value;
            const uploadFolder = `/uploads/discussions/${tempCode}/`;

            // Najdeme všechny obrázky v obsahu
            const imgRegex = /<img[^>]+src="([^"]+)"[^>]*>/g;
            const currentImages = new Set();

            let match;
            // Extrahujeme URL všech obrázků z obsahu
            while ((match = imgRegex.exec(content)) !== null) {
                const imageUrl = match[1];
                // Zpracujeme pouze obrázky patřící k této diskuzi
                if (imageUrl.includes(uploadFolder)) {
                    const fileName = imageUrl.split('/').pop();
                    if (fileName) {
                        currentImages.add(fileName);
                    }
                }
            }

            // Aktualizujeme seznam nahraných obrázků
            uploadedImages = Array.from(currentImages);
        }

        // Funkce pro čištění nepoužitých obrázků
        async function cleanupUnusedImages() {
            if (!canUploadFiles) return;

            const tempCode = document.getElementById('temp-discussion-code').value;

            try {
                // Získání seznamu všech nahraných obrázků pro tuto diskuzi
                const response = await fetch(`/upload/list?discussionCode=${tempCode}`, {
                    headers: {
                        'Authorization': `Bearer ${sessionStorage.getItem('JWTToken')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.files && data.files.length > 0) {
                        // Pro každý soubor zkontrolujeme, zda je v seznamu aktuálně používaných
                        for (const file of data.files) {
                            if (!uploadedImages.includes(file.name)) {
                                // Pokud soubor není používán, smažeme ho
                                await fetch(`/upload/delete-file`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${sessionStorage.getItem('JWTToken')}`
                                    },
                                    body: JSON.stringify({
                                        discussionCode: tempCode,
                                        fileName: file.name
                                    })
                                });
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Chyba při čištění nepoužitých obrázků:', error);
            }
        }

        // Funkce pro smazání adresáře s obrázky
        async function deleteImagesDirectory() {
            if (!canUploadFiles) return;

            const tempCode = document.getElementById('temp-discussion-code').value;

            try {
                await fetch(`${baseUrl}upload/delete-directory`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionStorage.getItem('JWTToken')}`
                    },
                    body: JSON.stringify({
                        code: tempCode
                    })
                });
            } catch (error) {
                console.error('Chyba při mazání adresáře s obrázky:', error);
            }
        }

        // Funkce pro přenos obsahu z editoru do skrytého textarea před odesláním formuláře
        function updateContent() {
            if (window.editor) {
                const content = window.editor.getData();
                const maxContentLength = 10000;

                if (content.length > maxContentLength) {
                    document.getElementById("modalMessage").textContent =
                    `Obsah diskuze nesmí být delší než ${maxContentLength} znaků. Aktuální délka: ${content.length}`;
                    new bootstrap.Modal(document.getElementById("errorModal")).show();

                    event.preventDefault(); // Zabrání odeslání formuláře
                    return false; // Zabránit odeslání formuláře
                }

                // Aktualizace seznamu nahraných obrázků
                trackUploadedImages();
                // Vyčištění nepoužitých obrázků před odesláním formuláře
                cleanupUnusedImages();

                document.querySelector('#editor-content').value = window.editor.getData();
            }
        }

        // Přidání event listenerů pro tlačítka
        document.addEventListener('DOMContentLoaded', function() {
            // Získání formuláře a tlačítek
            const form = document.getElementById('create-discussion-form');
            const backButton = document.getElementById('back-button');
            const submitButton = document.getElementById('submit-button');
            const hasVotingCheckbox = document.getElementById('hasVoting');
            const votingSection = document.getElementById('voting-section');
            const votingTypeSelect = document.getElementById('voting-type');

            // Obsluha změny checkboxu pro hlasování
            hasVotingCheckbox.addEventListener('change', function() {
                votingSection.style.display = this.checked ? 'block' : 'none';
                if (this.checked) {
                    // Pokud je hlasování zapnuto, nastavit hodnotu VoteType na "Visible" (1)
                    votingTypeSelect.value = "1";
                } else {
                    // Pokud je hlasování vypnuto, nastavit hodnotu VoteType na "None" (0)
                    votingTypeSelect.value = "0";
                }
            });

            // Poslouchání události odeslání formuláře
            form.addEventListener('submit', function(event) {
                // Aktualizujeme obsah z editoru
                updateContent();

                // Pokud je povoleno hlasování, validujeme otázky
                if (hasVotingCheckbox.checked) {
                    const questions = document.querySelectorAll('.voting-question');

                    // Ověříme, že existují nějaké otázky
                    if (questions.length === 0 && votingTypeSelect.value !== "0") {
                        event.preventDefault();
                        document.getElementById("modalMessage").textContent =
                            "Pro vytvoření hlasování je potřeba přidat alespoň jednu otázku.";
                        new bootstrap.Modal(document.getElementById("errorModal")).show();
                        return false;
                    }

                    // Připravíme data o hlasování pro odeslání
                    const votingQuestions = [];
                    let hasError = false;

                    questions.forEach((question, index) => {
                        const questionText = question.querySelector('.question-text').value.trim();
                        const questionOrder = parseInt(question.querySelector('.question-order').value);

                        if (!questionText) {
                            hasError = true;
                            document.getElementById("modalMessage").textContent =
                                `Otázka #${index + 1} nemá vyplněný text.`;
                            new bootstrap.Modal(document.getElementById("errorModal")).show();
                            return;
                        }

                        votingQuestions.push({
                            id: null, // Pro nové otázky je ID null
                            text: questionText,
                            displayOrder: questionOrder
                        });
                    });

                    if (hasError) {
                        event.preventDefault();
                        return false;
                    }

                    // Přidáme otázky do skrytého pole formuláře
                    const questionsInput = document.createElement('input');
                    questionsInput.type = 'hidden';
                    questionsInput.name = 'VotingQuestions';
                    questionsInput.value = JSON.stringify(votingQuestions);
                    form.appendChild(questionsInput);
                }
            });

            // Poslouchání kliknutí na tlačítko Zpět
            backButton.addEventListener('click', function(event) {
                // Při kliknutí na Zpět smažeme celý adresář s obrázky
                if (canUploadFiles) {
                    event.preventDefault();

                    // Potvrzení opuštění stránky
                    if (confirm('Opravdu chcete opustit stránku? Všechny vaše změny budou ztraceny.')) {
                        // Získáme kód kategorie z URL nebo ze skrytého inputu
                        const categoryCode = document.getElementById('temp-discussion-code').closest('form')
                                        .querySelector('[name="CategoryCode"]')?.value ||
                                        window.location.pathname.split('/').slice(-1)[0];

                        deleteImagesDirectory().then(() => {
                            // Explicitní přesměrování na stránku kategorie
                            window.location.href = `/Categories/${categoryCode}`;
                        }).catch(err => {
                            console.error("Chyba při mazání adresáře:", err);
                            // I v případě chyby při mazání přesměrujeme uživatele
                            window.location.href = `/Categories/${categoryCode}`;
                        });
                    }
                }
            });
        });



        // Kód pro vkládání emoji do editoru
        const emojiBtn = document.getElementById("emoji-btn");
        const emojiList = document.getElementById("emoji-list");
        const poleSmajliku = document.querySelectorAll("#emoji-list .emoji");

        // Zobrazení/skrytí panelu s emoji
        if (emojiBtn) {
            emojiBtn.addEventListener("click", function() {
                emojiList.style.display = emojiList.style.display === "block" ? "none" : "block";
            });
        }

        // Vložení emoji do editoru při kliknutí
        poleSmajliku.forEach(smajlik => {
            smajlik.addEventListener("click", function() {
                // Kontrola, zda globální instance CKEditoru existuje
                if (window.editor) {
                    const emoji = this.textContent;

                    // Použití API CKEditoru 5 pro vložení emoji
                    window.editor.model.change(writer => {
                        window.editor.model.insertContent(writer.createText(emoji));
                    });

                    // Skrytí panelu po kliknutí pro lepší UX
                    emojiList.style.display = "none";
                }
            });
        });
    </script>
}