@page "/Account/Profile"
@model ProfileModel
@{
    ViewData["Title"] = "Profil";

    //Pokud je jakýkoliv text v ErrorMessage, tak se zobrazí a zbytek stránky se nevykreslí
    if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-warning">
            <h4>@Model.ErrorMessage</h4>
        </div>
        return;
    }
    //Pokud je jakýkoliv text v StatusMessage, tak se zobrazí úplně nahoře a pokračuje se ve vykreslování stránky
    if (!string.IsNullOrEmpty(Model.StatusMessage))
    {
        <div class="alert alert-info">
            <h4>@Model.StatusMessage</h4>
        </div>
    }
}

<div class="container">
    <div class="col-md-6">
        <h2>Profil uživatele</h2>

        <div class="card mb-4">
            <div class="card-body">
                <dl>
                    <dt>Email</dt>
                    <dd>@Model.UserProfile?.Email</dd>
                    <dt>Přezdívka</dt>
                    <dd>@Model.UserProfile?.Nickname</dd>
                    <dt>Registrován</dt>
                    <dd>@Model.UserProfile?.Created.ToString("dd.MM.yyyy HH:mm")</dd>
                </dl>

                <!-- Sekce pro administrátory -->
                @if (Model.IsAdmin)
                {
                    <hr />
                    <div class="mt-3">
                        <h5>Administrátorské nástroje</h5>

                        <form method="post" asp-page-handler="CleanupDatabase" onsubmit="return confirm('POZOR! Tato akce smaže všechny záznamy označené jako smazané (Delete). Pokračovat?');">
                            <button type="submit" class="btn btn-danger">
                                <i class="bi bi-trash"></i> Vyčistit databázi
                            </button>
                        </form>

                        @if (Model.CleanupResult != null)
                        {
                            <div class="mt-3">
                                <h6>Výsledek čištění:</h6>
                                <ul class="list-group">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Lajky komentářů
                                        <span class="badge bg-primary rounded-pill">@Model.CleanupResult.DeletedCommentLikes</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Lajky diskuzí
                                        <span class="badge bg-primary rounded-pill">@Model.CleanupResult.DeletedDiscussionLikes</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Odpovědi na komentáře
                                        <span class="badge bg-primary rounded-pill">@Model.CleanupResult.DeletedCommentReplies</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Root komentáře
                                        <span class="badge bg-primary rounded-pill">@Model.CleanupResult.DeletedRootComments</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Diskuze (označené jako smazané)
                                        <span class="badge bg-primary rounded-pill">@Model.CleanupResult.DeletedDiscussions</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Diskuze smazaných uživatelů
                                        <span class="badge bg-primary rounded-pill">@Model.CleanupResult.DeletedUserDiscussions</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Komentáře smazaných uživatelů
                                        <span class="badge bg-primary rounded-pill">@Model.CleanupResult.DeletedUserComments</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Uživatelé
                                        <span class="badge bg-primary rounded-pill">@Model.CleanupResult.DeletedUsers</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <strong>Celkem</strong>
                                        <span class="badge bg-success rounded-pill">@Model.CleanupResult.TotalDeleted</span>
                                    </li>
                                </ul>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>

        <!-- Sekce s diskuzemi uživatele -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <button class="btn btn-link" type="button" id="toggle-discussions">
                        Moje diskuze <i class="bi bi-chevron-down" id="discussions-chevron"></i>
                    </button>
                </h5>
            </div>
            <div class="card-body" id="user-discussions" style="display: none;">
                @if (Model.UserDiscussions.Any())
                {
                    <div class="list-group">
                        @foreach (var discussion in Model.UserDiscussions)
                        {
                            <a href="/categories/@discussion.CategoryCode/@discussion.DiscussionCode" class="list-group-item list-group-item-action">
                                <div class="d-flex w-100 justify-content-between">
                                    <h5 class="mb-1">@discussion.Title</h5>
                                    <small>@discussion.UpdatedAt.ToLocalTime().ToString("dd.MM.yyyy HH:mm")</small>
                                </div>
                                <p class="mb-1">Kategorie: @discussion.CategoryName</p>
                                <small>
                                    <i class="bi bi-eye"></i> @discussion.ViewCount zobrazení
                                    <span class="mx-2">•</span>
                                    <i class="bi bi-calendar"></i> Vytvořeno: @discussion.CreatedAt.ToLocalTime().ToString("dd.MM.yyyy HH:mm")
                                </small>
                            </a>
                        }
                    </div>
                }
                else
                {
                    <p class="text-muted">Zatím jste nevytvořili žádné diskuze.</p>
                }
            </div>
        </div>

        <!-- Sekce pro změnu emailu -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Změna emailu</h5>
            </div>
            <div class="card-body">
                @if (!string.IsNullOrEmpty(Model.EmailErrorMessage))
                {
                    <div class="alert alert-danger">@Model.EmailErrorMessage</div>
                }
                <form method="post" asp-page-handler="UpdateEmail">
                    <div class="mb-3">
                        <label class="form-label">Nový email</label>
                        <input type="email" asp-for="NewEmail" class="form-control" required />
                    </div>
                    <button type="submit" class="btn btn-primary">Změnit email</button>
                </form>
            </div>
        </div>

        <!-- Sekce pro změnu přezdívky -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Změna přezdívky</h5>
            </div>
            <div class="card-body">
                @if (!string.IsNullOrEmpty(Model.NicknameErrorMessage))
                {
                    <div class="alert alert-danger">@Model.NicknameErrorMessage</div>
                }
                <form method="post" asp-page-handler="UpdateNickname">
                    <div class="mb-3">
                        <label class="form-label">Nová přezdívka</label>
                        <input type="text" asp-for="NewNickname" class="form-control" required />
                    </div>
                    <button type="submit" class="btn btn-primary">Změnit přezdívku</button>
                </form>
            </div>
        </div>

        <!-- Sekce pro změnu hesla -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Změna hesla</h5>
            </div>
            <div class="card-body">
                @if (!string.IsNullOrEmpty(Model.PasswordErrorMessage))
                {
                    <div class="alert alert-danger">@Model.PasswordErrorMessage</div>
                }
                <form method="post" asp-page-handler="ChangePassword">
                    <div class="mb-3">
                        <label class="form-label">Současné heslo</label>
                        <input type="password" asp-for="CurrentPassword" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Nové heslo</label>
                        <input type="password" asp-for="NewPassword" class="form-control" required />
                    </div>
                    <button type="submit" class="btn btn-primary">Změnit heslo</button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <script>
        // Funkce pro rozbalení/sbalení sekce s diskuzemi
        document.addEventListener('DOMContentLoaded', function () {
            const toggleButton = document.getElementById('toggle-discussions');
            const discussionsContainer = document.getElementById('user-discussions');
            const chevronIcon = document.getElementById('discussions-chevron');

            toggleButton.addEventListener('click', function () {
                if (discussionsContainer.style.display === 'none') {
                    discussionsContainer.style.display = 'block';
                    chevronIcon.classList.remove('bi-chevron-down');
                    chevronIcon.classList.add('bi-chevron-up');
                } else {
                    discussionsContainer.style.display = 'none';
                    chevronIcon.classList.remove('bi-chevron-up');
                    chevronIcon.classList.add('bi-chevron-down');
                }
            });
        });
    </script>
}