@page "/Account/Profile/{nickname}"
@using Zodpovedne.Contracts.Enums
@model ProfileModel
@{
    //Pokud je jakýkoliv text v ErrorMessage, tak se zobrazí a zbytek stránky se nevykreslí
    if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-warning">
            <h4>@Model.ErrorMessage</h4>
        </div>
        return;
    }
    //Pokud je jakýkoliv text v StatusMessage, tak se zobrazí úplně nahoře a pokračuje se ve vykreslování stránky
    if (!string.IsNullOrEmpty(Model.StatusMessage))
    {
        <div class="alert alert-info">
            <h4>@Model.StatusMessage</h4>
        </div>
    }
}

<div class="container">
    <div class="col-md-6 profile-wrapper">
        <h2 class="text-center">@(Model.FriendshipStatus == FriendshipStatus.Approved ? "Profil přítele" : "Profil uživatele")</h2>

        <div class="card mb-4 profile-info-box">
            <div class="card-body">
                <dl>
                    <dt>Přezdívka</dt>
                    <dd>@Model.UserProfile?.Nickname</dd>
                    <dt>Registrován</dt>
                    <dd>@Model.UserProfile?.Created.ToLocalTime().ToString("dd.MM.yyyy HH:mm")</dd>
                    @if (Model.CanViewFriendInfo)
                    {
                        @if (@Model.UserProfile?.LastLogin != null)
                        {
                            <dt>Poslední přihlášení</dt>
                            <dd>@Model.UserProfile?.LastLogin?.ToLocalTime().ToString("dd.MM.yyyy HH:mm")</dd>
                        }
                    }
                </dl>
            </div>
        </div>

        <!-- Tlačítko s žádostí o přátelství -->
        @if (Model.IsUserLoggedIn && Model.UserProfile?.Id != Model.UserId)
        {
            <div class="mt-3">
                @if (Model.CanRequestFriendship)
                {
                    <!-- Uživatel může odeslat novou žádost o přátelství -->
                    <form method="post" asp-page-handler="RequestFriendship" asp-route-targetUserId="@Model.UserProfile?.Id" asp-route-nickname="@Model.UserProfile?.Nickname">
                        <button type="submit" class="btn btn-primary mb-4">
                            <i class="bi bi-person-plus"></i> Požádat o přátelství
                        </button>
                    </form>
                }
                else if (Model.HasPendingFriendshipRequest)
                {
                    <!-- Žádost již byla odeslána, ale čeká na schválení -->
                    <button class="btn btn-secondary mb-4" disabled>
                        <i class="bi bi-hourglass-split"></i> Žádost odeslána
                    </button>
                }
                <!-- Pro stavy Approved (přijato) a Denied (odmítnuto) se nic nezobrazuje -->
            </div>
        }

        <!-- Sekce s přáteli uživatele - viditelná pouze pro přátele -->
        @if (Model.CanViewFriendInfo)
        {
            <div class="card mb-4" style="border:none;">
                <button class="d-flex justify-content-between w-100 account-toggle-wrapper" type="button" id="toggle-friends">
                    <span>Přátelé uživatele</span>
                    <i class="bi bi-chevron-down" id="friends-chevron"></i>

                </button>
                <div class="card-body scrollbar" id="friends-list">

                    @if (Model.UserFriends.Any())
                    {
                        <div class="table-responsive">

                            <table class="table table-hover">
                                <tbody>
                                    @foreach (var friend in Model.UserFriends)
                                    {
                                        <tr class="toggle-row">
                                            <td class="toggle-content-row d-flex justify-content-between p-1">
                                                <a href="/Account/Profile/@friend.OtherUserNickname" class="text-decoration-none">@friend.OtherUserNickname</a>
                                                <p class="card-text text-muted" style="width:auto;">
                                                    <i class="bi bi-calendar-plus"></i> <span style="font-size: 12px;">Přátelé od: @friend.CreatedAt.ToLocalTime().ToString("dd.MM.yyyy")</span>
                                                </p>
                                            </td>
                                        </tr>

                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted">Uživatel nemá zatím žádné přátele.</p>
                    }

                </div>

            </div>
        }

        <!-- Sekce s lajkovanými diskuzemi uživatele -->
        @if ((Model.CanViewFriendInfo) && (Model.LikedDiscussions.Any()))
        {
            <div class="card mb-4" style="border:none;">
                <button class="d-flex justify-content-between w-100 account-toggle-wrapper" type="button" id="toggle-likes">
                    <span>Naposledy lajkované diskuze</span>
                    <i class="bi bi-chevron-down" id="lekes-chevron"></i>

                </button>
                <div class="card-body" id="likes-list">
                    @foreach (var discussion in Model.LikedDiscussions)
                    {
                        <div class="table-responsive">

                            <table class="table table-hover">
                                <tbody>
                                    <tr class="toggle-row">
                                        <td class="toggle-content-row d-flex justify-content-between p-1">
                                            <a href="/Categories/@discussion.CategoryCode/@discussion.DiscussionCode" class="list-group-item list-group-item-action">
                                                <div class="d-flex w-100 justify-content-between">
                                                    <p class="mb-1 fw-bold" style="font-size: 12px;">@discussion.Title</p>
                                                </div>
                                                <p class="mb-1" style="font-size: 12px;">Kategorie: @discussion.CategoryName</p>
                                                <small style="font-size: 12px;">
                                                    <i class="bi bi-eye"></i> @discussion.ViewCount
                                                    <span>&nbsp;</span>
                                                    <i class="bi bi-person"></i> Autor: @discussion.AuthorNickname
                                                    <span>&nbsp;</span>
                                                    <i class="bi bi-calendar-plus"></i> @discussion.CreatedAt.ToLocalTime().ToString("dd.MM.yyyy")
                                                    <span style="font-size: 12px;">&nbsp;<i class="bi bi-pencil"></i> @discussion.UpdatedAt.ToLocalTime().ToString("dd.MM.yyyy")</span>

                                                </small>
                                            </a>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Sekce s diskuzemi uživatele -->
        @if (Model.CanViewFriendInfo)
        {
            <div class="card mb-4" style="border:none;">
                <button class="d-flex justify-content-between w-100 account-toggle-wrapper" type="button" id="toggle-discussions">
                    <span>Vytvořené diskuse</span>
                    <i class="bi bi-chevron-down" id="discussions-chevron"></i>

                </button>
                <div class="card-body scrollbar" id="user-discussions">
                    @if (Model.UserDiscussions.Any())
                    {
                        @foreach (var discussion in Model.UserDiscussions)
                        {
                            <div class="table-responsive">

                                <table class="table table-hover">
                                    <tbody>
                                        <tr class="toggle-row">
                                            <td class="toggle-content-row d-flex justify-content-between p-1">
                                                <a href="/Categories/@discussion.CategoryCode/@discussion.DiscussionCode" class="list-group-item list-group-item-action">
                                                    <div class="d-flex w-100 justify-content-between">
                                                        <p class="mb-1 fw-bold" style="font-size: 12px;">
                                                            @discussion.Title
                                                        </p>
                                                    </div>
                                                    <p class="mb-1" style="font-size: 12px;">Kategorie: @discussion.CategoryName</p>
                                                    <small style="font-size: 12px;">
                                                        <i class="bi bi-eye"></i> @discussion.ViewCount
                                                        <span>&nbsp;</span>
                                                        <i class="bi bi-calendar-plus"></i> @discussion.CreatedAt.ToLocalTime().ToString("dd.MM.yyyy")
                                                        <span style="font-size: 12px;">&nbsp;<i class="bi bi-pencil"></i> @discussion.UpdatedAt.ToLocalTime().ToString("dd.MM.yyyy")</span>

                                                    </small>
                                                </a>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        }

                    }
                    else
                    {
                        <p class="text-muted">Uživatel zatím nevytvořil žádné diskuze.</p>
                    }
                </div>
            </div>
        }
        <!-- Sekce s historií přihlášení - viditelná pouze pro adminy -->
        @if (Model.IsAdmin && Model.UserProfile != null)
        {
            <div class="card mb-4" style="border:none;">
                <button class="d-flex justify-content-between w-100 account-toggle-wrapper" type="button" id="toggle-login-history">
                    <span>Historie přihlášení <small class="text-danger">(vidí pouze admin)</small></span>
                    <i class="bi bi-chevron-down" id="login-history-chevron"></i>
                </button>
                <div class="card-body scrollbar" id="login-history-list" style="display:none;">
                    @if (Model.LoginHistory.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Čas přihlášení</th>
                                        <th>IP adresa</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var login in Model.LoginHistory)
                                    {
                                        <tr>
                                            <td>@login.LoginTime.ToLocalTime().ToString("dd.MM.yyyy HH:mm:ss")</td>
                                            <td>@login.IpAddress</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted">Pro tohoto uživatele není k dispozici žádná historie přihlášení.</p>
                    }
                </div>
            </div>

            <!-- JavaScript pro ovládání sekce historie přihlášení přímo zde v podmínce -->
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const toggleLoginHistoryBtn = document.getElementById('toggle-login-history');
                    const loginHistoryContainer = document.getElementById('login-history-list');
                    const loginHistoryChevron = document.getElementById('login-history-chevron');

                    if (toggleLoginHistoryBtn && loginHistoryContainer && loginHistoryChevron) {
                        toggleLoginHistoryBtn.addEventListener('click', function () {
                            if (loginHistoryContainer.style.display === 'none') {
                                loginHistoryContainer.style.display = 'block';
                                loginHistoryChevron.classList.remove('bi-chevron-down');
                                loginHistoryChevron.classList.add('bi-chevron-up');
                            } else {
                                loginHistoryContainer.style.display = 'none';
                                loginHistoryChevron.classList.remove('bi-chevron-up');
                                loginHistoryChevron.classList.add('bi-chevron-down');
                            }
                        });
                    }
                });
            </script>
        }
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <script defer>
        // Funkce pro rozbalení/sbalení sekce s diskuzemi
        document.addEventListener('DOMContentLoaded', function () {
            const toggleButton = document.getElementById('toggle-discussions');
            const discussionsContainer = document.getElementById('user-discussions');
            const chevronIcon = document.getElementById('discussions-chevron');

            if (toggleButton && discussionsContainer && chevronIcon) {
                toggleButton.addEventListener('click', function () {
                    if (discussionsContainer.style.display === 'none') {
                        discussionsContainer.style.display = 'block';
                        chevronIcon.classList.remove('bi-chevron-down');
                        chevronIcon.classList.add('bi-chevron-up');
                    } else {
                        discussionsContainer.style.display = 'none';
                        chevronIcon.classList.remove('bi-chevron-up');
                        chevronIcon.classList.add('bi-chevron-down');
                    }
                });
            }
        });

        // Kód pro přepínání sekce s přáteli
        document.addEventListener('DOMContentLoaded', function () {
            const toggleFriendsBtn = document.getElementById('toggle-friends');
            const friendsContainer = document.getElementById('friends-list');
            const friendsChevron = document.getElementById('friends-chevron');

            if (toggleFriendsBtn && friendsContainer && friendsChevron) {
                toggleFriendsBtn.addEventListener('click', function () {
                    if (friendsContainer.style.display === 'none') {
                        friendsContainer.style.display = 'block';
                        friendsChevron.classList.remove('bi-chevron-down');
                        friendsChevron.classList.add('bi-chevron-up');
                    } else {
                        friendsContainer.style.display = 'none';
                        friendsChevron.classList.remove('bi-chevron-up');
                        friendsChevron.classList.add('bi-chevron-down');
                    }
                });
            }
        });

        // Kód pro rozbalování sekce s naposledy lajkovanymi diskusemi
        document.addEventListener('DOMContentLoaded', function () {
            const toggleLikesBtn = document.getElementById('toggle-likes');
            const likesContainer = document.getElementById('likes-list');
            const likesChevron = document.getElementById('lekes-chevron');

            if (toggleLikesBtn && likesContainer && likesChevron) {
                toggleLikesBtn.addEventListener('click', function () {
                    if (likesContainer.style.display === 'none') {
                        likesContainer.style.display = 'block';
                        likesChevron.classList.remove('bi-chevron-down');
                        likesChevron.classList.add('bi-chevron-up');
                    } else {
                        likesContainer.style.display = 'none';
                        likesChevron.classList.remove('bi-chevron-up');
                        likesChevron.classList.add('bi-chevron-down');
                    }
                });
            }
        });
    </script>
}