@page "/Account/MyProfile"
@model MyProfileModel
@{
    ViewData["Title"] = "Můj profil";

    //Pokud je jakýkoliv text v ErrorMessage, tak se zobrazí a zbytek stránky se nevykreslí
    if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-warning">
            <h4>@Model.ErrorMessage</h4>
        </div>
        return;
    }
    //Pokud je jakýkoliv text v StatusMessage, tak se zobrazí úplně nahoře a pokračuje se ve vykreslování stránky
    if (!string.IsNullOrEmpty(Model.StatusMessage))
    {
        <div class="alert alert-info">
            <h4>@Model.StatusMessage</h4>
        </div>
    }
}

<div class="container">
    <div class="col-md-6 profile-wrapper">
        <h2 class="text-center" >Můj účet</h2>

        <div class="card mb-4 profile-info-box">
            <div class="card-body">
                <dl>
                    <dt>Email</dt>
                    <dd>@Model.UserProfile?.Email <button class="edit-account-btn" onclick="toggleEditEmail()">&nbsp;<i title="Upravit přezdívku" class="bi bi-pencil"></i></button></dd>
                    <dt>Přezdívka </dt>
                    <dd>@Model.UserProfile?.Nickname <button class="edit-account-btn" onclick="toggleEditPrezdivka()">&nbsp;<i title="Upravit přezdívku" class="bi bi-pencil"></i></button></dd>
                    <dt>Registrován</dt>
                    <dd>@Model.UserProfile?.Created.ToString("dd.MM.yyyy HH:mm")</dd>
                    @if (@Model.UserProfile?.LastLogin != null)
                    {
                        <dt>Poslední přihlášení</dt>
                        <dd>@Model.UserProfile?.LastLogin?.ToLocalTime().ToString("dd.MM.yyyy HH:mm")</dd>
                    }
                    <dt>Heslo</dt>
                    <dd><button class="edit-account-btn" onclick="toggleEditPassword()"> Změnit heslo</button></dd>
                </dl>

                <!-- Sekce pro administrátory -->
                @if (Model.IsAdmin)
                {
                    <hr />
                    <div class="mt-3">
                        <h5>Administrátorské nástroje</h5>

                        <form method="post" asp-page-handler="CleanupDatabase" onsubmit="return confirm('POZOR! Tato akce smaže všechny záznamy označené jako smazané (Delete). Pokračovat?');">
                            <button type="submit" class="btn btn-danger">
                                <i class="bi bi-trash"></i> Vyčistit databázi
                            </button>
                        </form>

                        @if (Model.CleanupResult != null)
                        {
                            <div class="mt-3">
                                <h6>Výsledek čištění:</h6>
                                <ul class="list-group">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Lajky komentářů
                                        <span class="badge bg-primary rounded-pill">@Model.CleanupResult.DeletedCommentLikes</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Lajky diskuzí
                                        <span class="badge bg-primary rounded-pill">@Model.CleanupResult.DeletedDiscussionLikes</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Odpovědi na komentáře
                                        <span class="badge bg-primary rounded-pill">@Model.CleanupResult.DeletedCommentReplies</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Root komentáře
                                        <span class="badge bg-primary rounded-pill">@Model.CleanupResult.DeletedRootComments</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Diskuze (označené jako smazané)
                                        <span class="badge bg-primary rounded-pill">@Model.CleanupResult.DeletedDiscussions</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Diskuze smazaných uživatelů
                                        <span class="badge bg-primary rounded-pill">@Model.CleanupResult.DeletedUserDiscussions</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Komentáře smazaných uživatelů
                                        <span class="badge bg-primary rounded-pill">@Model.CleanupResult.DeletedUserComments</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Uživatelé
                                        <span class="badge bg-primary rounded-pill">@Model.CleanupResult.DeletedUsers</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <strong>Celkem</strong>
                                        <span class="badge bg-success rounded-pill">@Model.CleanupResult.TotalDeleted</span>
                                    </li>
                                </ul>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>

        <!-- Sekce s přáteli -->
        <div class="card mb-4" style="border:none;">

            <button class="d-flex justify-content-between w-100 account-toggle-wrapper" type="button" id="toggle-friends">
                   <div> <span>Přátelé</span>
                @if (Model.HasFriendshipRequests)
                {
                    <span class="badge bg-primary">
                        @Model.Friendships.Count(f => f.Status == Zodpovedne.Contracts.Enums.FriendshipStatus.Requested && !f.IsRequester)
                    </span>
                }
                </div>
                    <i class="bi bi-chevron-down" id="friends-chevron"></i>
            </button>

            <div class="card-body" id="friends-list">
                @if (Model.Friendships.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <tbody>
                                @* Nejprve zobrazíme žádosti o přátelství (kde uživatel je schvalovatel) *@
                                @foreach (var friendship in Model.Friendships
                               .Where(f => f.Status == Zodpovedne.Contracts.Enums.FriendshipStatus.Requested && !f.IsRequester)
                               .OrderBy(f => f.OtherUserNickname))
                                {
                                    <tr class="toggle-row">
                                        <td class="toggle-content-row">
                                            <a href="/Account/Profile/@friendship.OtherUserNickname" class="text-decoration-none">
                                                @friendship.OtherUserNickname <span class="badge bg-danger" >žádá o přátelství</span>
                                            </a>
                                        </td>
                                        <td class="text-end toggle-content-row">
                                                <form method="post" asp-page-handler="ApproveFriendship" asp-route-friendshipId="@friendship.FriendshipId" class="d-inline">

                                                <button type="submit" class=" btn-outline-primary" style="height: 25px;vertical-align:bottom; background-color:transparent; border-radius: 5px;">
                                                    <svg width="15" height="15" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                                            <!-- Kulaté pozadí -->
                                                            <circle cx="10" cy="10" r="10" fill="#99cc33" />

                                                            <!-- Ikona fajfky -->
                                                            <path d="M6,10.2 L8.5,12.7 L14,7.2"
                                                                  fill="none"
                                                                  stroke="#006633"
                                                                  stroke-width="2"
                                                                  stroke-linecap="round"
                                                                  stroke-linejoin="round" />
                                                    </svg> <span style="font-size: 14px;">Potvrdit</span>
                                                    </button>
                                                </form>
                                                <form method="post" asp-page-handler="DenyFriendship" asp-route-friendshipId="@friendship.FriendshipId" class="d-inline ms-1">
                                                <button type="submit" class="btn-outline-primary" style="height: 25px;vertical-align:bottom; background-color:transparent; border-radius: 5px;">
                                                    &nbsp;
                                                    <svg width="15" height="15" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                                            <!-- Kulaté pozadí -->
                                                            <circle cx="10" cy="10" r="10" fill="#dc3545" />

                                                            <!-- Ikona křížku -->
                                                            <path d="M7,7 L13,13 M13,7 L7,13"
                                                                  fill="none"
                                                                  stroke="white"
                                                                  stroke-width="2"
                                                                  stroke-linecap="round"
                                                                  stroke-linejoin="round" />
                                                    </svg> <span style="font-size: 14px;">Zrušit  &nbsp;</span>
                                                    </button>
                                                </form>
                                        </td>
                                    </tr>
                                }

                                @* Potom zobrazíme již potvrzená přátelství *@
                                @foreach (var friendship in Model.Friendships
                               .Where(f => f.Status == Zodpovedne.Contracts.Enums.FriendshipStatus.Approved)
                               .OrderBy(f => f.OtherUserNickname))
                                {
                                    <tr class="toggle-row">
                                        <td class="toggle-content-row">
                                            <a href="/Account/Profile/@friendship.OtherUserNickname" class="text-decoration-none">
                                                @friendship.OtherUserNickname
                                            </a>
                                        </td>
                                        <td class="text-end toggle-content-row" style="vertical-align: bottom;">
                                            <form method="post" asp-page-handler="RemoveFriendship" asp-route-friendshipId="@friendship.FriendshipId"
                                                  onsubmit="return confirm('Opravdu chcete odebrat tohoto přítele?');">
                                                <button type="submit" style="font-size: 14px;" class="btn btn-outline-danger btn-odebrat pb-4">
                                                    <i class="bi bi-person-dash"></i> Odebrat
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                }

                                @* Zobrazíme i odeslané žádosti o přátelství *@
                                @foreach (var friendship in Model.Friendships
                               .Where(f => f.Status == Zodpovedne.Contracts.Enums.FriendshipStatus.Requested && f.IsRequester)
                               .OrderBy(f => f.OtherUserNickname))
                                {
                                    <tr class="toggle-row">
                                        <td class="toggle-content-row">
                                            <a href="/Account/Profile/@friendship.OtherUserNickname" class="text-decoration-none">
                                                @friendship.OtherUserNickname <span class="badge bg-secondary">čeká na potvrzení</span>
                                            </a>
                                        </td>
                                        <td class="text-end toggle-content-row">
                                            <form method="post" asp-page-handler="RemoveFriendship" asp-route-friendshipId="@friendship.FriendshipId"
                                                  onsubmit="return confirm('Opravdu chcete zrušit tuto žádost o přátelství?');">
                                                <button type="submit" class="btn-outline-primary" style="height: 25px;vertical-align:bottom; background-color:transparent; border-radius: 5px;">
                                                    <span style="font-size: 14px;">Zrušit žádost</span>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                }

                                @* Nakonec zobrazíme zamítnuté žádosti o přátelství *@
                                @foreach (var friendship in Model.Friendships
                               .Where(f => f.Status == Zodpovedne.Contracts.Enums.FriendshipStatus.Denied)
                               .OrderBy(f => f.OtherUserNickname))
                                {
                                    <tr class="toggle-row">
                                        <td class="toggle-content-row">
                                            <a href="/Account/Profile/@friendship.OtherUserNickname" class="text-decoration-none text-secondary">
                                                @friendship.OtherUserNickname <span class="badge bg-light text-secondary">zamítnuto</span>
                                            </a>
                                        </td>
                                        <td class="text-end toggle-content-row">
                                            <form method="post" asp-page-handler="RemoveFriendship" asp-route-friendshipId="@friendship.FriendshipId"
                                                  onsubmit="return confirm('Opravdu chcete odstranit tohoto uživatele ze seznamu zamítnutých?');">
                                                <button type="submit" class="btn btn-outline-secondary btn-sm">
                                                    <i class="bi bi-trash"></i> Odstranit ze zamítnutých
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <p class="text-muted">Zatím nemáte žádné přátele.</p>
                }
            </div>
        </div>

        <!-- Sekce s diskuzemi uživatele -->
        <div class="card mb-4" style="border:none;">

            <button class="d-flex justify-content-between w-100 account-toggle-wrapper" type="button" id="toggle-discussions">
                Moje diskuze <i class="bi bi-chevron-down" id="discussions-chevron"></i>
            </button>

            <div class="card-body" id="user-discussions" ">
                @if (Model.UserDiscussions.Any())
                {
                    <div class="list-group ">
                        @foreach (var discussion in Model.UserDiscussions)
                        {
                            <a href="/Categories/@discussion.CategoryCode/@discussion.DiscussionCode" class="list-group-item toggle-list-group-item list-group-item-action">
                                <div class="d-flex w-100 justify-content-between">
                                    <p class="mb-1 fw-bold" style="font-size: 12px;">@discussion.Title</p>
                                    <span style="font-size: 12px;">@discussion.UpdatedAt.ToLocalTime().ToString("dd.MM.yyyy HH:mm")</span>
                                </div>
                                <p class="mb-1" style="font-size: 11px;">Kategorie: @discussion.CategoryName</p>
                                <small>
                                    <i class="bi bi-eye"></i><span style="font-size: 11px;">
                                        @discussion.ViewCount </span>
                                    <span>&nbsp;</span>
                                    <i class="bi bi-calendar-plus"></i><span style="font-size: 11px;"> @discussion.CreatedAt.ToLocalTime().ToString("dd.MM.yyyy HH:mm") </span>
                                </small>
                            </a>
                        }
                    </div>
                }
                else
                {
                    <p class="text-muted">Zatím jste nevytvořili žádné diskuze.</p>
                }
            </div>
        </div>

        <!-- Sekce s notifikacemi o nových odpovědích -->
        <div class="card mb-4" style="border:none;">

            <button class="d-flex justify-content-between w-100 account-toggle-wrapper" type="button" id="toggle-notifications">
                <div>
                Nové odpovědi
                @if (Model.NewRepliesNotifications.Any())
                {
                    <span class="badge bg-primary">@Model.NewRepliesNotifications.Count</span>
                }
                </div>
                <i class="bi bi-chevron-down" id="notifications-chevron"></i>
       
            </button>

            <div class="card-body" id="new-replies-notifications">
                @if (Model.NewRepliesNotifications.Any())
                {
                    <div class="list-group">
                        @foreach (var notification in Model.NewRepliesNotifications)
                        {
                            <a href="@notification.DiscussionUrl" class="list-group-item list-group-item-action">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1 text-break">@notification.Title</h6>
                                    <small>@notification.LatestReplyTime.ToLocalTime().ToString("dd.MM.yyyy HH:mm")</small>
                                </div>
                                <p class="mb-1">
                                    Kategorie: @notification.CategoryName
                                    <span class="badge bg-info ms-2" title="Počet vašich komentářů s novými odpověďmi">
                                        <i class="bi bi-chat-dots-fill"></i> @notification.CommentsWithNewRepliesCount
                                    </span>
                                </p>
                            </a>
                        }
                    </div>
                }
                else
                {
                    <p class="text-muted">Nemáte žádné nové odpovědi.</p>
                }
            </div>
        </div>

        <!-- Sekce pro změnu emailu -->
        <dialog class="card mb-4" id="change-email-account">
            <div class="d-flex justify-content-end">
                <button type="button" class="btn-dialog-close btn-close" onClick="closeEditEmail()" aria-label="Close">
                </button>
            </div>
    
            <div>
                <h5 class="mb-0 mt-1 text-center">Změna emailu</h5>
            </div>
            <div class="card-body">
                @if (!string.IsNullOrEmpty(Model.EmailErrorMessage))
                {
                    <div class="alert alert-danger">@Model.EmailErrorMessage</div>
                }
                <form method="post" asp-page-handler="UpdateEmail">
                    <div class="mb-3">
                        <label class="form-label">Nový email</label>
                        <input type="email" asp-for="NewEmail" class="form-control" required />
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Změnit email</button>
                </form>
            </div>
        </dialog>

        <!-- Sekce pro změnu přezdívky -->
        <dialog class="card mb-4" id="change-prezdivka-account">
            <div class="d-flex justify-content-end">
                <button type="button" class="btn-dialog-close btn-close" onClick="closeEditPrezdivka()" aria-label="Close">
                </button>
            </div>
            <h5 class="mb-0 text-center">Změna přezdívky</h5>
            <div class="card-body">
                @if (!string.IsNullOrEmpty(Model.NicknameErrorMessage))
                {
                    <div class="alert alert-danger">@Model.NicknameErrorMessage</div>
                }
                <form method="post" asp-page-handler="UpdateNickname">
                    <div class="mb-3">
                        <label class="form-label">Nová přezdívka</label>
                        <input type="text" asp-for="NewNickname" class="form-control" required />
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Změnit přezdívku</button>
                </form>
            </div>
        </dialog>

        <!-- Sekce pro změnu hesla -->
        <dialog class="card" id="change-password-account">
            <div class="d-flex justify-content-end">
                <button type="button" class="btn-dialog-close btn-close" onClick="closeEditPassword()" aria-label="Close">
                </button>
            </div>
            <h5 class="mb-0 text-center">Změna hesla</h5>
            <div class="card-body">
                @if (!string.IsNullOrEmpty(Model.PasswordErrorMessage))
                {
                    <div class="alert alert-danger">@Model.PasswordErrorMessage</div>
                }
                <form method="post" asp-page-handler="ChangePassword">
                    <div class="mb-3">
                        <label class="form-label">Současné heslo</label>
                        <input type="password" asp-for="CurrentPassword" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Nové heslo</label>
                        <input type="password" asp-for="NewPassword" class="form-control" required />
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Změnit heslo</button>
                </form>
            </div>
        </dialog>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <script defer>
        let changeEmailAccount = document.getElementById('change-email-account');
        let changePrezdivkaAccount = document.getElementById('change-prezdivka-account');
        let changePasswordAccount = document.getElementById('change-password-account');

        function toggleEditEmail() {
            if (changeEmailAccount) {
                changeEmailAccount.showModal();
            }
        }
        function closeEditEmail() {
            if (changeEmailAccount) {
                changeEmailAccount.close();
            }
        }    
        function toggleEditPrezdivka() {
            if (changeEmailAccount) {
                changePrezdivkaAccount.showModal();
            }
        }

        function closeEditPrezdivka() {
            if (changeEmailAccount) {
               changePrezdivkaAccount.close();
            }
        }
        function toggleEditPassword() {
            if (changeEmailAccount) {
                changePasswordAccount.showModal();
            }
        }

        function closeEditPassword() {
            if (changeEmailAccount) {
               changePasswordAccount.close();
            }
        }

        // Funkce pro rozbalení/sbalení sekce s diskuzemi
        document.addEventListener('DOMContentLoaded', function () {
            const toggleButton = document.getElementById('toggle-discussions');
            const discussionsContainer = document.getElementById('user-discussions');
            const chevronIcon = document.getElementById('discussions-chevron');

            toggleButton.addEventListener('click', function () {
                if (discussionsContainer.style.display === 'none') {
                    discussionsContainer.style.display = 'block';
                    chevronIcon.classList.remove('bi-chevron-down');
                    chevronIcon.classList.add('bi-chevron-up');
                } else {
                    discussionsContainer.style.display = 'none';
                    chevronIcon.classList.remove('bi-chevron-up');
                    chevronIcon.classList.add('bi-chevron-down');
                }
            });

            // Rozbalení a zabalení seznamu diskuzí, kde přihlášený uživatel má nějakou reakci na svůj komentář
            const toggleNotificationsButton = document.getElementById('toggle-notifications');
            const notificationsContainer = document.getElementById('new-replies-notifications');
            const notificationsChevronIcon = document.getElementById('notifications-chevron');

            toggleNotificationsButton.addEventListener('click', function () {
                if (notificationsContainer.style.display === 'none') {
                    notificationsContainer.style.display = 'block';
                    notificationsChevronIcon.classList.remove('bi-chevron-down');
                    notificationsChevronIcon.classList.add('bi-chevron-up');
                } else {
                    notificationsContainer.style.display = 'none';
                    notificationsChevronIcon.classList.remove('bi-chevron-up');
                    notificationsChevronIcon.classList.add('bi-chevron-down');
                }
            });

             // Kód pro přepínání sekce s přáteli
            const toggleFriendsBtn = document.getElementById('toggle-friends');
            const friendsContainer = document.getElementById('friends-list');
            const friendsChevron = document.getElementById('friends-chevron');

            toggleFriendsBtn.addEventListener('click', function () {
                if (friendsContainer.style.display === 'none') {
                    friendsContainer.style.display = 'block';
                    friendsChevron.classList.remove('bi-chevron-down');
                    friendsChevron.classList.add('bi-chevron-up');
                } else {
                    friendsContainer.style.display = 'none';
                    friendsChevron.classList.remove('bi-chevron-up');
                    friendsChevron.classList.add('bi-chevron-down');
                }
            });

        // Pokud element existuje, nastavíme event listenery
        if (changeEmailAccount) {
       
            changeEmailAccount.addEventListener("click", function(e) {
                // Uložíme si souřadnice dialogového okna
                let souradniceDialogOkna = changeEmailAccount.getBoundingClientRect();

                if (
                    e.clientX < souradniceDialogOkna.left ||
                    e.clientX > souradniceDialogOkna.right ||
                    e.clientY < souradniceDialogOkna.top ||
                    e.clientY > souradniceDialogOkna.bottom
                ) {
                    changeEmailAccount.close(); // Zavře dialogové okno
                }
            });
        }
        // Pokud element existuje, nastavíme event listenery
        if (changePrezdivkaAccount) {
            changePrezdivkaAccount.addEventListener("click", function(e) {
                // Uložíme si souřadnice dialogového okna
                let souradniceDialogOkna = changeEmailAccount.getBoundingClientRect();

                if (
                    e.clientX < souradniceDialogOkna.left ||
                    e.clientX > souradniceDialogOkna.right ||
                    e.clientY < souradniceDialogOkna.top ||
                    e.clientY > souradniceDialogOkna.bottom
                ) {
                    changePrezdivkaAccount.close(); // Zavře dialogové okno
                }
            });
        }
        // Pokud element existuje, nastavíme event listenery
        if (changePasswordAccount) {
            changePasswordAccount.addEventListener("click", function(e) {
                // Uložíme si souřadnice dialogového okna
                let souradniceDialogOkna = changeEmailAccount.getBoundingClientRect();

                if (
                    e.clientX < souradniceDialogOkna.left ||
                    e.clientX > souradniceDialogOkna.right ||
                    e.clientY < souradniceDialogOkna.top ||
                    e.clientY > souradniceDialogOkna.bottom
                ) {
                    changePasswordAccount.close(); // Zavře dialogové okno
                }
            });
        }

        });
    </script>
}