@page "/categories/{categoryCode}"
@model CategoryModel
@{
    ViewData["Title"] = Model.CategoryName;
    /* Detail Kategorie */ 

    // Kontrola chybových stavů
    if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-warning">
            <h4>@Model.ErrorMessage</h4>
        </div>
        return;
    }
    if (!string.IsNullOrEmpty(Model.StatusMessage))
    {
        <div class="alert alert-info">
            <h4>@Model.StatusMessage</h4>
        </div>
    }
}

<div class="container">
    @* Záhlaví kategorie *@
    <div class="row mb-4">
        <div class="col">
            <h1 class="long-word-break">@Model.CategoryName</h1>
            @if (!string.IsNullOrEmpty(Model.CategoryDescription))
            {
                <p class="lead">@Model.CategoryDescription</p>
            }
        </div>
    </div>

    @* Seznam diskuzí *@
    <div id="discussions-container">
        @if (Model.Discussions.Any())
        {
            @* Kontejner pro seznam diskuzí - do něj se budou přidávat nové diskuze *@
            <div class="row" id="discussions-list">
                @foreach (var discussion in Model.Discussions.OrderByDescending(d => d.Type == Zodpovedne.Contracts.Enums.DiscussionType.Top)
               .ThenByDescending(d => d.UpdatedAt))
                {
                    await Html.RenderPartialAsync("_DiscussionPartial", discussion);
                }
            </div>

            @* Ovládací prvky pro načítání dalších diskuzí *@
            @if (Model.HasNextPage)
            {
                <div id="loading-container" class="text-center mb-4">
                    <button id="load-more" class="btn btn-primary" onclick="loadMoreDiscussions()">
                        Načíst další diskuze
                    </button>
                    <div id="loading-spinner" class="d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Načítání...</span>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="row">
                <div class="col">
                    <div class="alert alert-info">
                        V této kategorii zatím nejsou žádné diskuze.
                    </div>
                </div>
            </div>
        }
    </div>

    @* Tlačítko pro vytvoření nové diskuze (pouze pro přihlášené uživatele) *@
    @if (HttpContext.Session.GetString("JWTToken") != null)
    {
        <div class="row mt-4">
            <div class="col">
                <a href="/discussion/create/@Model.CategoryCode" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Nová diskuze
                </a>
            </div>
        </div>
    }
</div>

@* Skryté inputy pro JavaScript *@
<input type="hidden" id="category-id" value="@Model.CategoryId" />
<input type="hidden" id="current-page" value="@Model.CurrentPage" />

@section Scripts {
    @* Bootstrap ikony *@
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <script>
        // Inicializace při načtení stránky
        document.addEventListener('DOMContentLoaded', function () {
        });

        /**
         * Načte další stránku diskuzí pomocí AJAX a přidá je do seznamu
         */
        async function loadMoreDiscussions() {
            const loadMoreBtn = document.getElementById('load-more');
            const loadingSpinner = document.getElementById('loading-spinner');
            const container = document.getElementById('discussions-list');
            const currentPage = parseInt(document.getElementById('current-page').value);
            const categoryId = document.getElementById('category-id').value;

            try {
                // Zobrazení loading stavu
                loadMoreBtn.classList.add('d-none');
                loadingSpinner.classList.remove('d-none');

                // Tento kód volá handler OnGetNextPageAsync (z Category.cshtml) pro načtení dat další stránky diskuzí z API
                // do response vrátí načtené diskuze (pro 1 stránku) plus informace ok stránkování
                // Je to konvence ASP.NET Core Razor Pages, že ?handler=NextPage zavolá C# metodu OnGetNextPageAsync...
                const response = await fetch(`?handler=NextPage&categoryId=${categoryId}&currentPage=${currentPage}`, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (!response.ok) throw new Error('Načítání selhalo');

                // do data se dostane json s načtenými diskuzemi plus informace o stránkování
                const data = await response.json();

                // Načtení HTML pro každou diskuzi pomocí Partial View
                for (const discussion of data.discussions) {
                    // Pro každou diskuzi z nově načtených dat zavolá handler pro vykreslení jedné diskuze
                    // Tento AJAX požadavek volá handler OnPostDiscussionPartialAsync (CategoryModel z Category.cshtml.cs)
                    const htmlResponse = await fetch(`?handler=DiscussionPartial&categoryCode=${data.categoryCode}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify(discussion)
                    });

                    if (htmlResponse.ok) {
                        const html = await htmlResponse.text();
                        container.insertAdjacentHTML('beforeend', html);
                    }
                }

                // Aktualizace stavu stránkování
                document.getElementById('current-page').value = data.currentPage;

                // Zobrazení/skrytí tlačítka pro načtení dalších diskuzí
                if (data.hasNextPage) {
                    loadMoreBtn.classList.remove('d-none');
                } else {
                    document.getElementById('loading-container').remove();
                }
            } catch (error) {
                console.error('Chyba při načítání:', error);
                loadMoreBtn.classList.remove('d-none');
            } finally {
                loadingSpinner.classList.add('d-none');
            }
        }
    </script>
}